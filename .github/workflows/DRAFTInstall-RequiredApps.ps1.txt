# file: Install-RequiredApps.ps1
<#
.SYNOPSIS
  Installs required applications, including Crestron AirMedia.
#>

# --- PREREQUISITE CHECK ---
if (-not ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
  Write-Warning "Run as Administrator."
  Read-Host "Press Enter to exit"
  exit 1
}

# Harden web requests
try { [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12 -bor [Net.SecurityProtocolType]::Tls13 } catch {}
$ProgressPreference = 'SilentlyContinue'  # why: avoid slow downloads on large files

# --- CONFIGURATION ---
$RequiredApps = @(
  @{ AppName="Box";               Type="MSI";   CheckMethod="Registry"; Url="https://e3.boxcdn.net/box-installers/desktop/releases/win/Box-x64.msi" },
  @{ AppName="Box for Office";    Type="EXE";   CheckMethod="Registry"; Url="https://e3.boxcdn.net/box-installers/boxforoffice/currentrelease/BoxForOffice.exe"; SilentArgs="/quiet /norestart" }, # verify vendor flags if needed
  @{ AppName="Box Tools";         Type="EXE";   CheckMethod="Registry"; Url="https://e3.boxcdn.net/box-installers/boxedit/win/currentrelease/BoxToolsInstaller.exe"; SilentArgs="/S" },             # NSIS often uses /S
  @{ AppName="Windows Calculator";Type="WINGET";CheckMethod="Appx";     AppxName="Microsoft.WindowsCalculator"; WingetId="Microsoft.WindowsCalculator" },
  @{ AppName="Crestron AirMedia"; Type="WINGET";CheckMethod="Registry"; WingetId="Crestron.AirMedia" }
)

# --- HELPERS ---
function Test-WingetAvailable {
  $p = Get-Command winget.exe -ErrorAction SilentlyContinue
  return ($null -ne $p)
}

function Test-AppInstalled {
  [CmdletBinding()]
  param([hashtable]$App)

  if ($App.CheckMethod -eq 'Appx' -and $App.AppxName) {
    $pkg = Get-AppxPackage -Name $App.AppxName -ErrorAction SilentlyContinue
    return ($null -ne $pkg)
  }

  $paths = @(
    'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*',
    'HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*',
    'HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*',
    'HKCU:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*'
  )
  $pattern = $App.AppName
  $hit = Get-ItemProperty -Path $paths -ErrorAction SilentlyContinue |
         Where-Object { $_.DisplayName -and ($_.DisplayName -like $pattern) } |
         Select-Object -First 1
  return ($null -ne $hit)
}

function Invoke-GenericInstall {
  [CmdletBinding()]
  param([hashtable]$App)

  $appName = $App.AppName
  $type    = $App.Type
  Write-Host "--- Installing '$appName' ($type) ---" -ForegroundColor Cyan

  $process = $null
  $tmp = $null

  try {
    switch ($type) {
      'MSI' {
        $url = $App.Url
        if (-not $url) { throw "MSI URL missing for $appName." }
        $fname = [IO.Path]::GetFileName($url)
        $tmp   = Join-Path $env:TEMP $fname
        Invoke-WebRequest -Uri $url -OutFile $tmp -UseBasicParsing -ErrorAction Stop
        $args = "/i `"$tmp`" /qn /norestart"
        $process = Start-Process -FilePath "msiexec.exe" -ArgumentList $args -Wait -PassThru -ErrorAction Stop
      }
      'EXE' {
        $url = $App.Url
        if (-not $url) { throw "EXE URL missing for $appName." }
        $fname = [IO.Path]::GetFileName($url)
        $tmp   = Join-Path $env:TEMP $fname
        Invoke-WebRequest -Uri $url -OutFile $tmp -UseBasicParsing -ErrorAction Stop
        $silent = if ($App.SilentArgs) { $App.SilentArgs } else { '/quiet /norestart' }  # why: avoid UI hangs
        $args = $silent
        $process = Start-Process -FilePath $tmp -ArgumentList $args -Wait -PassThru -ErrorAction Stop
      }
      'WINGET' {
        if (-not (Test-WingetAvailable)) { throw "winget not found. Install App Installer from Microsoft Store." }
        $id = $App.WingetId
        if (-not $id) { throw "WingetId missing for $appName." }
        $args = @(
          'install','--id', $id,'-e',
          '--accept-package-agreements','--accept-source-agreements',
          '--silent','--disable-interactivity'
        )
        $process = Start-Process -FilePath "winget.exe" -ArgumentList $args -Wait -PassThru -ErrorAction Stop
      }
      default { throw "Unknown installer Type '$type' for $appName." }
    }

    $code = if ($process) { $process.ExitCode } else { 0 }
    if ($code -ne 0 -and $code -ne 3010) { throw "Non-zero exit code $code." }
    if ($code -eq 3010) { Write-Host "'$appName' installed. Reboot required." -ForegroundColor Yellow }
    else { Write-Host "'$appName' installed." -ForegroundColor Green }
  }
  catch {
    Write-Host "ERROR installing '$appName': $($_.Exception.Message)" -ForegroundColor Red
  }
  finally {
    if ($tmp -and (Test-Path $tmp)) { Remove-Item -Path $tmp -Force -ErrorAction SilentlyContinue }
  }
}

# --- MAIN ---
Write-Host "Scanning required applications..."
$toInstall = @()
foreach ($app in $RequiredApps) {
  if (Test-AppInstalled -App $app) {
    Write-Host " - Found: $($app.AppName)" -ForegroundColor Green
  } else {
    Write-Host " - Missing: $($app.AppName)" -ForegroundColor Yellow
    $toInstall += $app
  }
}

if ($toInstall.Count -gt 0) {
  Write-Host "--------------------------------------------------"
  Write-Warning "Missing applications detected: $($toInstall.Count)"
  $choice = Read-Host "Create a System Restore Point before installing? (Y/N)"
  if ($choice -match '^[Yy]$') {
    Write-Host "Creating System Restore Point..." -ForegroundColor Yellow
    try {
      Checkpoint-Computer -Description "Before app deployment" -ErrorAction Stop
      Write-Host "Restore Point created." -ForegroundColor Green
    } catch {
      Write-Warning "Restore Point failed. Ensure System Protection is enabled."
      $continue = Read-Host "Continue anyway? (Y/N)"
      if ($continue -notmatch '^[Yy]$') { Write-Host "Canceled."; exit 0 }
    }
  }

  foreach ($app in $toInstall) { Invoke-GenericInstall -App $app }
} else {
  Write-Host "All required applications are installed." -ForegroundColor Green
}

Write-Host "--------------------------------------------------"
Write-Host "Done." -ForegroundColor Cyan
Read-Host "Press Enter to exit"
exit 0